# Building Native C Firmware for PyBoard

## Goal

Replace MicroPython with native C firmware that replicates the same functionality but runs **100-500x faster**.

## What We're Building

A native C firmware for the **PyBoard v1.1 (STM32F405RG)** that includes:

| Feature | MicroPython Equivalent |
|---------|----------------------|
| 4 LEDs (Red, Green, Yellow, Blue) | `pyb.LED(1-4)` |
| LED4 PWM brightness control | `LED(4).intensity()` |
| MMA7660 Accelerometer | `pyb.Accel()` |
| ADC input | `pyb.ADC()` |
| DAC output | `pyb.DAC()` |
| PWM output | `pyb.Timer().channel()` |
| GPIO control | `pyb.Pin()` |
| User button | `pyb.Switch()` |
| Serial CLI | REPL-like commands |

## Project Structure

```
PyBoard_Native/
├── PyBoard_Native.ioc      # STM32CubeMX configuration
├── Core/
│   ├── Inc/
│   │   ├── main.h          # Pin definitions
│   │   ├── mma7660.h       # Accelerometer driver header
│   │   └── stm32f4xx_*.h   # HAL configuration
│   └── Src/
│       ├── main.c          # Main program with CLI
│       ├── mma7660.c       # Accelerometer driver
│       └── stm32f4xx_*.c   # HAL callbacks
├── Drivers/                # (Generated by STM32CubeMX)
│   ├── CMSIS/
│   └── STM32F4xx_HAL_Driver/
└── Debug/                  # (Build output)
    └── PyBoard_Native.hex  # Final firmware
```

## Build Process

### Step 1: Open STM32CubeIDE

```
C:\ST\STM32CubeIDE_2.0.0\STM32CubeIDE\stm32cubeide.exe
```

### Step 2: Import the Project

1. **File → Import → General → Existing Projects into Workspace**
2. Browse to: `c:\Users\bob43\Downloads\micropython testing software\PyBoard_Native`
3. Check "PyBoard_Native" in the project list
4. Click **Finish**

### Step 3: Generate Code from .ioc File

1. Double-click `PyBoard_Native.ioc` in the Project Explorer
2. STM32CubeMX will open inside the IDE
3. If prompted to download STM32F4 firmware package, click **Yes**
4. Click the **Generate Code** button (gear icon) or press **Alt+K**
5. This creates:
   - `Drivers/CMSIS/` - ARM core files
   - `Drivers/STM32F4xx_HAL_Driver/` - ST HAL library
   - Startup assembly file
   - Linker script

### Step 4: Build the Project

**Option A: GUI**
- Right-click project → **Build Project**
- Or press **Ctrl+B**

**Option B: Command Line**
```batch
"C:\ST\STM32CubeIDE_2.0.0\STM32CubeIDE\stm32cubeidec.exe" ^
  --launcher.suppressErrors -nosplash ^
  -application org.eclipse.cdt.managedbuilder.core.headlessbuild ^
  -data "c:/Users/bob43/STM32CubeIDE/workspace_2.0.0" ^
  -build "PyBoard_Native/Debug"
```

### Step 5: Find the Output

After successful build:
- **ELF file:** `Debug/PyBoard_Native.elf`
- **HEX file:** `Debug/PyBoard_Native.hex`
- **BIN file:** `Debug/PyBoard_Native.bin`

## Flashing the Firmware

### Option 1: DFU Mode (USB)

1. Hold **BOOT0** button (or set jumper)
2. Press **RESET**
3. Use STM32CubeProgrammer or dfu-util:

```bash
dfu-util -a 0 -D PyBoard_Native.hex
```

### Option 2: ST-LINK

If you have an ST-LINK debugger:
```bash
st-flash write PyBoard_Native.bin 0x8000000
```

Or use STM32CubeProgrammer GUI.

### Option 3: From STM32CubeIDE

- Click **Run → Run** or press **F11**
- Requires ST-LINK connected

## Using the Firmware

Connect via serial at **115200 baud** (same as MicroPython):

```
===========================================
PyBoard Native Firmware v1.0
STM32F405RG @ 168MHz
Type 'help' for commands
===========================================
> help
Commands:
  help          - Show this help
  info          - System information
  led N [0|1]   - Control LED (1-4)
  intensity N   - Set LED4 brightness (0-255)
  accel [N]     - Read accelerometer (N times)
  adc           - Read ADC value
  dac N         - Set DAC output (0-4095)
  pwm N         - Set PWM duty (0-100%)
  gpio N [0|1]  - Read/write GPIO X1/X2
  button        - Read user button
  speed         - Run CPU speed test
  demo          - LED demo
```

## Performance Comparison

| Operation | MicroPython | Native C | Speedup |
|-----------|-------------|----------|---------|
| 1M loop iterations | ~780 ms | ~6 ms | **130x** |
| GPIO toggle | ~50 µs | ~0.1 µs | **500x** |
| Accelerometer read | ~1 ms | ~10 µs | **100x** |

## Why This Process?

STM32CubeIDE uses **STM32CubeMX** internally to:

1. **Parse the .ioc file** - Contains all peripheral configurations
2. **Download HAL drivers** - STM32F4xx_HAL_Driver (~50 source files)
3. **Generate startup code** - Assembly startup and linker scripts
4. **Create build system** - Makefiles for the ARM GCC toolchain

The headless CLI build (`stm32cubeidec.exe -build`) only works after the code generation step, which requires the GUI or a separate STM32CubeMX installation.

## Troubleshooting

### "Project doesn't appear to be a CDT project"
- The .ioc file hasn't been processed yet
- Open STM32CubeIDE GUI and generate code first

### "No Config matched"
- Project not imported correctly
- Re-import using File → Import

### Missing HAL drivers
- STM32F4 firmware package not downloaded
- Open .ioc file, IDE will prompt to download

## Files in This Directory

| File | Purpose |
|------|---------|
| `find_port.py` | Find available COM ports |
| `test_micropython.py` | Test MicroPython REPL |
| `test_all_io.py` | Test all PyBoard peripherals |
| `PyBoard_Native/` | Native C firmware project |
