<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyBoard Oscilloscope</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #00ff88;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff8855;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .scope-container {
            background: #0a0a15;
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 30px #00ff8833;
        }
        canvas {
            width: 100%;
            background: #000;
            border-radius: 5px;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .control-group {
            background: #16213e;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control-group label {
            color: #00ff88;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        input[type="range"] {
            width: 120px;
            accent-color: #00ff88;
        }
        .value {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        .stats {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 20px;
        }
        .stat {
            text-align: center;
        }
        .stat-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .status.connected { background: #00ff8833; color: #00ff88; }
        .status.disconnected { background: #ff555533; color: #ff5555; }
        .trigger-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: #ff5555;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ PyBoard Oscilloscope</h1>
        
        <div id="status" class="status disconnected">Connecting...</div>
        
        <div class="scope-container">
            <canvas id="scope" width="1100" height="400"></canvas>
            
            <div class="controls">
                <div class="control-group" style="background: #2e1a3e;">
                    <label style="color: #ff88ff;">PWM Frequency</label>
                    <input type="range" id="pwmFreq" min="10" max="10000" value="500" style="accent-color: #ff88ff;">
                    <span class="value" id="pwmFreqVal" style="color: #ff88ff;">500 Hz</span>
                </div>
                <div class="control-group" style="background: #2e1a3e;">
                    <label style="color: #ff88ff;">PWM Duty %</label>
                    <input type="range" id="pwmDuty" min="0" max="100" value="50" style="accent-color: #ff88ff;">
                    <span class="value" id="pwmDutyVal" style="color: #ff88ff;">50%</span>
                </div>
                <div class="control-group">
                    <label>Time/Div</label>
                    <input type="range" id="timeDiv" min="1" max="50" value="10">
                    <span class="value" id="timeDivVal">10 ms</span>
                </div>
                <div class="control-group">
                    <label>Volts/Div</label>
                    <input type="range" id="voltsDiv" min="1" max="10" value="5">
                    <span class="value" id="voltsDivVal">0.5 V</span>
                </div>
                <div class="control-group">
                    <label>Trigger Level</label>
                    <input type="range" id="trigger" min="0" max="4095" value="2048">
                    <span class="value" id="triggerVal">1.65 V</span>
                </div>
                <div class="control-group">
                    <label>Mode</label>
                    <select id="mode" style="padding: 5px; border-radius: 4px;">
                        <option value="auto">Auto</option>
                        <option value="normal">Normal</option>
                        <option value="single">Single</option>
                    </select>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat" style="background: #2e1a3e; padding: 10px; border-radius: 8px;">
                    <div class="stat-label" style="color: #ff88ff;">PWM Freq</div>
                    <div class="stat-value" id="pwmFreqStat" style="color: #ff88ff;">-- Hz</div>
                </div>
                <div class="stat" style="background: #2e1a3e; padding: 10px; border-radius: 8px;">
                    <div class="stat-label" style="color: #ff88ff;">PWM Duty</div>
                    <div class="stat-value" id="pwmDutyStat" style="color: #ff88ff;">--%</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Vpp</div>
                    <div class="stat-value" id="vpp">0.00 V</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Vmax</div>
                    <div class="stat-value" id="vmax">0.00 V</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Vmin</div>
                    <div class="stat-value" id="vmin">0.00 V</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Freq</div>
                    <div class="stat-value" id="freq">-- Hz</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Samples/s</div>
                    <div class="stat-value" id="sps">0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('scope');
        const ctx = canvas.getContext('2d');
        
        let samples = [];
        let ws = null;
        let lastSampleCount = 0;
        let spsTime = Date.now();
        
        // Connect to WebSocket
        function connect() {
            ws = new WebSocket('ws://localhost:8765');
            
            ws.onopen = () => {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '● Connected to PyBoard';
            };
            
            ws.onclose = () => {
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = '○ Disconnected - Reconnecting...';
                setTimeout(connect, 2000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                samples = data.samples;
                
                // Update PWM stats from server
                if (data.freq) {
                    document.getElementById('pwmFreqStat').textContent = data.freq + ' Hz';
                }
                if (data.duty) {
                    document.getElementById('pwmDutyStat').textContent = data.duty + '%';
                }
                
                // Calculate samples per second
                const now = Date.now();
                if (now - spsTime >= 1000) {
                    const sps = (samples.length - lastSampleCount) * (1000 / (now - spsTime));
                    document.getElementById('sps').textContent = Math.round(sps).toLocaleString();
                    lastSampleCount = samples.length;
                    spsTime = now;
                }
                
                draw();
            };
            
            ws.onerror = () => {
                ws.close();
            };
        }
        
        function adcToVolts(adc) {
            return (adc / 4095) * 3.3;
        }
        
        function draw() {
            const width = canvas.width;
            const height = canvas.height;
            const timeDiv = parseInt(document.getElementById('timeDiv').value);
            const voltsDiv = parseInt(document.getElementById('voltsDiv').value) / 10;
            const triggerLevel = parseInt(document.getElementById('trigger').value);
            
            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            
            // Vertical divisions (time)
            for (let i = 0; i <= 10; i++) {
                const x = (width / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Horizontal divisions (voltage)
            for (let i = 0; i <= 8; i++) {
                const y = (height / 8) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Center lines
            ctx.strokeStyle = '#555';
            ctx.beginPath();
            ctx.moveTo(width/2, 0);
            ctx.lineTo(width/2, height);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, height/2);
            ctx.lineTo(width, height/2);
            ctx.stroke();
            
            // Trigger line
            const triggerY = height - (triggerLevel / 4095) * height;
            ctx.strokeStyle = '#ff5555';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, triggerY);
            ctx.lineTo(width, triggerY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw waveform
            if (samples.length > 1) {
                const samplesPerDiv = Math.max(5, timeDiv * 2);
                const displaySamples = samplesPerDiv * 10;
                const startIdx = Math.max(0, samples.length - displaySamples);
                const visibleSamples = samples.slice(startIdx);
                
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 2;
                ctx.shadowColor = '#00ff88';
                ctx.shadowBlur = 5;
                ctx.beginPath();
                
                for (let i = 0; i < visibleSamples.length; i++) {
                    const x = (i / visibleSamples.length) * width;
                    const y = height - (visibleSamples[i] / 4095) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                ctx.shadowBlur = 0;
                
                // Calculate stats
                const vmax = Math.max(...visibleSamples);
                const vmin = Math.min(...visibleSamples);
                const vpp = vmax - vmin;
                
                document.getElementById('vmax').textContent = adcToVolts(vmax).toFixed(2) + ' V';
                document.getElementById('vmin').textContent = adcToVolts(vmin).toFixed(2) + ' V';
                document.getElementById('vpp').textContent = adcToVolts(vpp).toFixed(2) + ' V';
                
                // Estimate frequency (zero crossings)
                let crossings = 0;
                const mid = (vmax + vmin) / 2;
                for (let i = 1; i < visibleSamples.length; i++) {
                    if ((visibleSamples[i-1] < mid && visibleSamples[i] >= mid) ||
                        (visibleSamples[i-1] >= mid && visibleSamples[i] < mid)) {
                        crossings++;
                    }
                }
                if (crossings > 2) {
                    // Rough frequency estimate (assuming 2kHz sample rate)
                    const freq = (crossings / 2) * (2000 / visibleSamples.length);
                    document.getElementById('freq').textContent = Math.round(freq) + ' Hz';
                } else {
                    document.getElementById('freq').textContent = '-- Hz';
                }
            }
            
            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '11px monospace';
            ctx.fillText('3.3V', 5, 15);
            ctx.fillText('0V', 5, height - 5);
        }
        
        // Update control displays
        document.getElementById('timeDiv').oninput = function() {
            document.getElementById('timeDivVal').textContent = this.value + ' ms';
        };
        document.getElementById('voltsDiv').oninput = function() {
            document.getElementById('voltsDivVal').textContent = (this.value / 10).toFixed(1) + ' V';
        };
        document.getElementById('trigger').oninput = function() {
            document.getElementById('triggerVal').textContent = ((this.value / 4095) * 3.3).toFixed(2) + ' V';
        };
        
        // PWM controls
        document.getElementById('pwmFreq').oninput = function() {
            document.getElementById('pwmFreqVal').textContent = this.value + ' Hz';
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({freq: parseInt(this.value)}));
            }
        };
        document.getElementById('pwmDuty').oninput = function() {
            document.getElementById('pwmDutyVal').textContent = this.value + '%';
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({duty: parseInt(this.value)}));
            }
        };
        
        // Start
        connect();
    </script>
</body>
</html>
